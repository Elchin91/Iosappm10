name: Build iOS IPA with Xcode

on:
  workflow_dispatch:

jobs:
  build:
    name: Build IPA with Xcode
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Prebuild iOS project
        run: |
          npx expo prebuild --platform ios --clean || \
          (echo "‚ö†Ô∏è Prebuild failed, trying without clean..." && npx expo prebuild --platform ios)

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install
          cd ..

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: List available SDKs
        run: |
          echo "=== Available SDKs ==="
          xcodebuild -showsdks
          echo ""
          echo "=== Available Schemes ==="
          xcodebuild -list -workspace ios/M10Wallet.xcworkspace || xcodebuild -list -project ios/M10Wallet.xcodeproj

      - name: Build Archive
        run: |
          set -e
          mkdir -p ${{ github.workspace }}/build
          
          # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—É—é –≤–µ—Ä—Å–∏—é iOS SDK
          echo "üîç –ò—â–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ SDK..."
          xcodebuild -showsdks
          IOS_SDK=$(xcodebuild -showsdks | grep -o 'iphoneos[0-9.]*' | head -n 1 | sed 's/iphoneos//' || echo "")
          
          if [ -z "$IOS_SDK" ]; then
            echo "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –≤–µ—Ä—Å–∏—è SDK, –∏—Å–ø–æ–ª—å–∑—É–µ–º iphoneos"
            SDK_ARG="-sdk iphoneos"
          else
            echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º SDK: iphoneos$IOS_SDK"
            SDK_ARG="-sdk iphoneos$IOS_SDK"
          fi
          
          echo "üî® –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –∞—Ä—Ö–∏–≤–∞..."
          # –°–æ–±–∏—Ä–∞–µ–º –∞—Ä—Ö–∏–≤ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
          if xcodebuild archive \
            -workspace ios/M10Wallet.xcworkspace \
            -scheme M10Wallet \
            -configuration Release \
            $SDK_ARG \
            -archivePath ${{ github.workspace }}/build/M10Wallet.xcarchive \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            PROVISIONING_PROFILE_SPECIFIER="" \
            2>&1 | tee build.log; then
            echo "‚úÖ –ê—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"
          else
            echo "‚ùå –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–æ–±—É–µ–º –±–µ–∑ —è–≤–Ω–æ–≥–æ SDK..."
            cat build.log || true
            xcodebuild archive \
              -workspace ios/M10Wallet.xcworkspace \
              -scheme M10Wallet \
              -configuration Release \
              -archivePath ${{ github.workspace }}/build/M10Wallet.xcarchive \
              CODE_SIGN_IDENTITY="-" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO || \
            (echo "‚ùå –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —Å–±–æ—Ä–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å" && exit 1)
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω
          if [ ! -d "${{ github.workspace }}/build/M10Wallet.xcarchive" ]; then
            echo "‚ùå –ê—Ä—Ö–∏–≤ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω!"
            exit 1
          fi
          echo "‚úÖ –ê—Ä—Ö–∏–≤ –Ω–∞–π–¥–µ–Ω: ${{ github.workspace }}/build/M10Wallet.xcarchive"

      - name: Export IPA
        run: |
          mkdir -p ${{ github.workspace }}/build/ipa
          # –ü—Ä–æ–±—É–µ–º —ç–∫—Å–ø–æ—Ä—Ç —Å ad-hoc
          if xcodebuild -exportArchive \
            -archivePath ${{ github.workspace }}/build/M10Wallet.xcarchive \
            -exportPath ${{ github.workspace }}/build/ipa \
            -exportOptionsPlist ${{ github.workspace }}/exportOptions.plist \
            -allowProvisioningUpdates 2>&1; then
            echo "‚úÖ IPA —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ xcodebuild"
          else
            echo "‚ö†Ô∏è xcodebuild export –Ω–µ —É–¥–∞–ª—Å—è, —Å–æ–∑–¥–∞–µ–º IPA –≤—Ä—É—á–Ω—É—é..."
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É IPA –¥–ª—è Trollstore
            PAYLOAD_DIR="${{ github.workspace }}/build/ipa/Payload"
            mkdir -p "$PAYLOAD_DIR"
            cp -r "${{ github.workspace }}/build/M10Wallet.xcarchive/Products/Applications/M10Wallet.app" "$PAYLOAD_DIR/"
            cd "${{ github.workspace }}/build/ipa"
            zip -r M10Wallet.ipa Payload
            rm -rf Payload
            echo "‚úÖ IPA —Å–æ–∑–¥–∞–Ω –≤—Ä—É—á–Ω—É—é: ${{ github.workspace }}/build/ipa/M10Wallet.ipa"
          fi

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: M10Wallet-IPA-Xcode
          path: build/ipa/*.ipa
          retention-days: 30

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/ipa/*.ipa
          tag_name: v${{ github.run_number }}-xcode
          name: Release v${{ github.run_number }} (Xcode Build)
          body: |
            IPA —Ñ–∞–π–ª —Å–æ–±—Ä–∞–Ω —á–µ—Ä–µ–∑ Xcode –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ Trollstore
            
            ## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ:
            1. –°–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª M10Wallet.ipa
            2. –û—Ç–∫—Ä–æ–π—Ç–µ Trollstore –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
            3. –í—ã–±–µ—Ä–∏—Ç–µ "Install IPA File"
            4. –í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
            5. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

